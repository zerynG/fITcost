{% extends "itcost/base_with_sidebar.html" %}

{% block title %}{{ calculation|default_if_none:"Новый расчет" }}{% endblock %}

{% block main_content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-0">
                        {% if calculation %}
                            Редактирование расчета: {{ calculation.project_name }}
                        {% else %}
                            Новый расчет стоимости
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="calculation-form">
                        {% csrf_token %}
                        
                        <!-- Общие ошибки формы -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Сообщения Django -->
                        {% if messages %}
                            <div class="mb-3">
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Основные поля расчета -->
                        <h6 class="mb-3">Основная информация</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.project_name.label }}{% if form.project_name.field.required %} *{% endif %}</label>
                                {{ form.project_name }}
                                {% for error in form.project_name.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.client_name.label }}{% if form.client_name.field.required %} *{% endif %}</label>
                                {{ form.client_name }}
                                {% for error in form.client_name.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-12">
                                <label class="form-label">{{ form.project_brief.label }}{% if form.project_brief.field.required %} *{% endif %}</label>
                                {{ form.project_brief }}
                                {% for error in form.project_brief.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Выбор источника данных НМА -->
                        {% if form.nma_source.field.widget.input_type != 'hidden' %}
                        <h6 class="mb-3">Источник данных НМА</h6>
                        <div class="mb-4">
                            {% for choice in form.nma_source %}
                                <div class="form-check mb-2">
                                    {{ choice.tag }}
                                    <label class="form-check-label" for="{{ choice.id_for_label }}">
                                        {{ choice.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                            {% for error in form.nma_source.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            
                            <!-- Выбор существующей формы НМА -->
                            {% if form.existing_nma.field.widget.input_type != 'hidden' %}
                            <div id="existing-nma-section" class="mt-3" style="display: none;">
                                <label class="form-label">{{ form.existing_nma.label }}</label>
                                {{ form.existing_nma }}
                                {% for error in form.existing_nma.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Форма создания новой НМА -->
                            <div id="new-nma-section" class="mt-3" style="display: none;">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Создание новой формы НМА</h6>
                                        {% if nma_form %}
                                            {% for field in nma_form %}
                                                <div class="mb-3">
                                                    <label class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
                                                    {{ field }}
                                                    {% for error in field.errors %}
                                                        <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Выбор источника данных коммерческого предложения -->
                        {% if form.commercial_source.field.widget.input_type != 'hidden' %}
                        <h6 class="mb-3">Источник данных коммерческого предложения</h6>
                        <div class="mb-4">
                            {% for choice in form.commercial_source %}
                                <div class="form-check mb-2">
                                    {{ choice.tag }}
                                    <label class="form-check-label" for="{{ choice.id_for_label }}">
                                        {{ choice.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                            {% for error in form.commercial_source.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            
                            <!-- Выбор существующего коммерческого предложения -->
                            {% if form.existing_commercial.field.widget.input_type != 'hidden' %}
                            <div id="existing-commercial-section" class="mt-3" style="display: none;">
                                <label class="form-label">{{ form.existing_commercial.label }}</label>
                                {{ form.existing_commercial }}
                                {% for error in form.existing_commercial.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Форма создания нового коммерческого предложения -->
                            <div id="new-commercial-section" class="mt-3" style="display: none;">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Создание нового коммерческого предложения</h6>
                                        {% if commercial_form %}
                                            {% for field in commercial_form %}
                                                <div class="mb-3">
                                                    <label class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
                                                    {{ field }}
                                                    {% for error in field.errors %}
                                                        <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            {% endfor %}
                                            
                                            {% if service_formset %}
                                                <h6 class="mt-4">Услуги</h6>
                                                {{ service_formset.management_form }}
                                                <div id="service-items">
                                                    {% for form_item in service_formset %}
                                                        <div class="service-item mb-3 p-3 border rounded">
                                                            {% for field in form_item %}
                                                                {% if not field.is_hidden %}
                                                                    <div class="mb-2">
                                                                        <label class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
                                                                        {{ field }}
                                                                        {% for error in field.errors %}
                                                                            <div class="text-danger small">{{ error }}</div>
                                                                        {% endfor %}
                                                                    </div>
                                                                {% else %}
                                                                    {{ field }}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Параметры расчета -->
                        <h6 class="mb-3">Параметры расчета</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.estimated_hours.label }}{% if form.estimated_hours.field.required %} *{% endif %}</label>
                                {{ form.estimated_hours }}
                                {% for error in form.estimated_hours.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.hourly_rate.label }}{% if form.hourly_rate.field.required %} *{% endif %}</label>
                                {{ form.hourly_rate }}
                                {% for error in form.hourly_rate.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.infrastructure_cost.label }}{% if form.infrastructure_cost.field.required %} *{% endif %}</label>
                                {{ form.infrastructure_cost }}
                                {% for error in form.infrastructure_cost.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.other_expenses.label }}{% if form.other_expenses.field.required %} *{% endif %}</label>
                                {{ form.other_expenses }}
                                {% for error in form.other_expenses.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.management_overhead_percent.label }}{% if form.management_overhead_percent.field.required %} *{% endif %}</label>
                                {{ form.management_overhead_percent }}
                                {% for error in form.management_overhead_percent.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.risk_percent.label }}{% if form.risk_percent.field.required %} *{% endif %}</label>
                                {{ form.risk_percent }}
                                {% for error in form.risk_percent.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.profit_margin_percent.label }}{% if form.profit_margin_percent.field.required %} *{% endif %}</label>
                                {{ form.profit_margin_percent }}
                                {% for error in form.profit_margin_percent.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.asset_capitalization_percent.label }}{% if form.asset_capitalization_percent.field.required %} *{% endif %}</label>
                                {{ form.asset_capitalization_percent }}
                                {% for error in form.asset_capitalization_percent.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.commercial_markup_percent.label }}{% if form.commercial_markup_percent.field.required %} *{% endif %}</label>
                                {{ form.commercial_markup_percent }}
                                {% for error in form.commercial_markup_percent.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Скрытые поля -->
                        {{ form.nma_cost }}
                        {{ form.commercial_proposal }}

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% url 'itcost:dashboard' %}" class="btn btn-link">Вернуться к дашборду</a>
                            <button type="submit" class="btn btn-primary">
                                {% if calculation %}Сохранить изменения{% else %}Создать расчет{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('calculation-form');
    
    // Обработка выбора источника НМА
    const nmaSourceRadios = document.querySelectorAll('input[name="nma_source"]');
    const existingNmaSection = document.getElementById('existing-nma-section');
    const newNmaSection = document.getElementById('new-nma-section');
    
    if (nmaSourceRadios.length > 0 && existingNmaSection && newNmaSection) {
        function toggleNmaSections() {
            const selectedValue = document.querySelector('input[name="nma_source"]:checked')?.value;
            if (selectedValue === 'existing') {
                existingNmaSection.style.display = 'block';
                newNmaSection.style.display = 'none';
                // Делаем поля новой формы НМА необязательными
                if (newNmaSection) {
                    const nmaFields = newNmaSection.querySelectorAll('input[required], select[required], textarea[required]');
                    nmaFields.forEach(field => {
                        field.removeAttribute('required');
                        field.setAttribute('data-was-required', 'true');
                    });
                }
            } else if (selectedValue === 'new') {
                existingNmaSection.style.display = 'none';
                newNmaSection.style.display = 'block';
                // Восстанавливаем required для полей новой формы НМА
                if (newNmaSection) {
                    const nmaFields = newNmaSection.querySelectorAll('input[data-was-required], select[data-was-required], textarea[data-was-required]');
                    nmaFields.forEach(field => {
                        field.setAttribute('required', 'required');
                    });
                }
            } else {
                existingNmaSection.style.display = 'none';
                newNmaSection.style.display = 'none';
                // Делаем поля новой формы НМА необязательными
                if (newNmaSection) {
                    const nmaFields = newNmaSection.querySelectorAll('input[required], select[required], textarea[required]');
                    nmaFields.forEach(field => {
                        field.removeAttribute('required');
                        field.setAttribute('data-was-required', 'true');
                    });
                }
            }
        }
        
        nmaSourceRadios.forEach(radio => {
            radio.addEventListener('change', toggleNmaSections);
        });
        toggleNmaSections(); // Инициализация
    }
    
    // Обработка выбора источника коммерческого предложения
    const commercialSourceRadios = document.querySelectorAll('input[name="commercial_source"]');
    const existingCommercialSection = document.getElementById('existing-commercial-section');
    const newCommercialSection = document.getElementById('new-commercial-section');
    
    if (commercialSourceRadios.length > 0 && existingCommercialSection && newCommercialSection) {
        function toggleCommercialSections() {
            const selectedValue = document.querySelector('input[name="commercial_source"]:checked')?.value;
            if (selectedValue === 'existing') {
                existingCommercialSection.style.display = 'block';
                newCommercialSection.style.display = 'none';
                // Делаем поля новой формы коммерческого предложения необязательными
                if (newCommercialSection) {
                    const commercialFields = newCommercialSection.querySelectorAll('input[required], select[required], textarea[required]');
                    commercialFields.forEach(field => {
                        field.removeAttribute('required');
                        field.setAttribute('data-was-required', 'true');
                    });
                }
            } else if (selectedValue === 'new') {
                existingCommercialSection.style.display = 'none';
                newCommercialSection.style.display = 'block';
                // Восстанавливаем required для полей новой формы коммерческого предложения
                if (newCommercialSection) {
                    const commercialFields = newCommercialSection.querySelectorAll('input[data-was-required], select[data-was-required], textarea[data-was-required]');
                    commercialFields.forEach(field => {
                        field.setAttribute('required', 'required');
                    });
                }
            } else {
                existingCommercialSection.style.display = 'none';
                newCommercialSection.style.display = 'none';
                // Делаем поля новой формы коммерческого предложения необязательными
                if (newCommercialSection) {
                    const commercialFields = newCommercialSection.querySelectorAll('input[required], select[required], textarea[required]');
                    commercialFields.forEach(field => {
                        field.removeAttribute('required');
                        field.setAttribute('data-was-required', 'true');
                    });
                }
            }
        }
        
        commercialSourceRadios.forEach(radio => {
            radio.addEventListener('change', toggleCommercialSections);
        });
        toggleCommercialSections(); // Инициализация
    }
    
    // Обработка отправки формы - делаем поля вложенных форм необязательными, если они скрыты
    if (form) {
        form.addEventListener('submit', function(e) {
            const nmaSource = document.querySelector('input[name="nma_source"]:checked')?.value;
            const commercialSource = document.querySelector('input[name="commercial_source"]:checked')?.value;
            
            // Если выбрано "Не использовать" или "Выбрать существующую", делаем поля новой формы необязательными
            if (nmaSource !== 'new' && newNmaSection) {
                const nmaFields = newNmaSection.querySelectorAll('input, select, textarea');
                nmaFields.forEach(field => {
                    field.removeAttribute('required');
                    field.disabled = true; // Отключаем поля, чтобы они не отправлялись
                });
            }
            
            if (commercialSource !== 'new' && newCommercialSection) {
                const commercialFields = newCommercialSection.querySelectorAll('input, select, textarea');
                commercialFields.forEach(field => {
                    field.removeAttribute('required');
                    field.disabled = true; // Отключаем поля, чтобы они не отправлялись
                });
            }
            
            // Если выбрано "Не использовать" или не выбрано значение для "Выбрать существующую", делаем эти поля необязательными
            if (nmaSource === 'none' || (nmaSource === 'existing' && !document.querySelector('select[name="existing_nma"]')?.value)) {
                const existingNmaField = document.querySelector('select[name="existing_nma"]');
                if (existingNmaField) {
                    existingNmaField.removeAttribute('required');
                }
            }
            
            if (commercialSource === 'none' || (commercialSource === 'existing' && !document.querySelector('select[name="existing_commercial"]')?.value)) {
                const existingCommercialField = document.querySelector('select[name="existing_commercial"]');
                if (existingCommercialField) {
                    existingCommercialField.removeAttribute('required');
                }
            }
        });
    }
});
</script>
{% endblock main_content %}


